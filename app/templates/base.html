<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}EchoDent{% endblock %}</title>

  {# Dynamic CSS Variables for Theme Colors #}
  <style>
    :root {
      --primary-color: {{ theme_primary_color }};
      --secondary-color: {{ theme_secondary_color }};
    }
  </style>

  {# CSS Assets com Cache-Busting (AGENTS.MD Auditoria §4.2) #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}?v={{ asset_v }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/documentos.css') }}?v={{ asset_v }}" />
  {# settings.css REMOVIDO - agora carrega condicionalmente apenas em /settings #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/global_search.css') }}?v={{ asset_v }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/undo_toast.css') }}?v={{ asset_v }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/toast_with_undo.css') }}?v={{ asset_v }}" />
  {% block styles %}{% endblock %}
  <script src="{{ url_for('static', filename='js/theme-toggle.js') }}?v={{ asset_v }}" defer></script>
  <script src="{{ url_for('static', filename='js/app.js') }}?v={{ asset_v }}" defer></script>
</head>
<body class="{% block body_class %}{% endblock %}">
  {% if current_user.is_authenticated %}
    {% include '_sidebar.html' %}
  {% endif %}

  <div class="main-content-wrapper">
    <header class="main-header">
      <div class="layout-container inner">
        <div class="brand">EchoDent</div>
        {% if current_user.is_authenticated %}
          <div class="global-search-wrapper">
            <input
              type="search"
              class="global-search-input"
              placeholder="Buscar paciente..."
              name="q"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
              inputmode="search"
              aria-autocomplete="none"
              data-lpignore="true"
              data-1p-ignore="true"
              autofill="off"
              readonly
              hx-get="{{ url_for('paciente_bp.busca_global') }}"
              hx-trigger="input changed delay:300ms"
              hx-target="#global-search-results"
              hx-swap="innerHTML"
            />
            <div id="global-search-results" class="global-search-results"></div>
          </div>
        {% endif %}
        <nav>
          {% if (not current_user.is_authenticated) and request.endpoint != 'auth_bp.login' %}
            <a class="btn btn-secondary" href="{{ url_for('auth_bp.login') }}">Entrar</a>
          {% endif %}
        </nav>
      </div>
    </header>

    <main class="layout-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages mb-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ category | default('info') }} mb-2" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
    </main>
  </div>

  <!-- Toast Notification Container (Fase 1.2) -->
  <div id="toast-container"></div>

  <!-- HTMX Modal Container (Fase 4+) -->
  <div id="modal-container"></div>

  <!-- Modal de Erro reutilizável (inicialmente oculto) -->
  <div id="error-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-card">
      <h3 class="modal-title">Erro</h3>
      <div class="alert alert-danger" id="error-modal-message">Ocorreu um erro.</div>
      <pre id="error-modal-text" class="pre-wrap"></pre>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="copy-error-btn">Copiar Erro</button>
        <button type="button" class="btn btn-secondary" data-close-modal>Fechar</button>
      </div>
    </div>
  </div>
  <!-- HTMX local (offline-first) -->
  <script src="{{ url_for('static', filename='js/htmx.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/undo_toast.js') }}?v={{ asset_v }}" defer></script>
  <script src="{{ url_for('static', filename='js/toast_with_undo.js') }}?v={{ asset_v }}" defer></script>
  <script src="{{ url_for('static', filename='js/modal.js') }}?v={{ asset_v }}" defer></script>
  {% block scripts %}{% endblock %}
</body>
</html>
