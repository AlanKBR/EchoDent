{% extends "base.html" %}
{% block title %}Configurações Globais{% endblock %}

{% block styles %}
<style>
/* Estilos escopados para a página de configurações */
.configuracoes-container {
  max-width: 1000px;
  margin: 0 auto;
}

.configuracoes-container h1 {
  margin-bottom: var(--space-6);
}

.settings-tabs {
  display: flex;
  gap: var(--space-2);
  border-bottom: 2px solid var(--color-border);
  margin-bottom: var(--space-5);
}

.settings-tab {
  padding: var(--space-3) var(--space-4);
  background: transparent;
  border: none;
  color: var(--color-text-secondary);
  font-weight: 500;
  cursor: pointer;
  transition: color var(--transition-short), border-color var(--transition-short);
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
}

.settings-tab:hover {
  color: var(--color-text-primary);
}

.settings-tab.active {
  color: var(--color-primary-main);
  border-bottom-color: var(--color-primary-main);
}

.settings-section {
  display: none;
}

.settings-section.active {
  display: block;
}

.settings-group {
  margin-bottom: var(--space-5);
}

.settings-group h3 {
  font-size: 1.125rem;
  margin-bottom: var(--space-4);
  color: var(--color-text-primary);
  padding-bottom: var(--space-2);
  border-bottom: 1px solid var(--color-border);
}

.setting-item {
  margin-bottom: var(--space-4);
}

.setting-item label {
  display: block;
  font-weight: 500;
  margin-bottom: var(--space-2);
  color: var(--color-text-primary);
}

.setting-item .setting-description {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  margin-bottom: var(--space-2);
}

.setting-item input,
.setting-item select,
.setting-item textarea {
  width: 100%;
  max-width: 500px;
}

.setting-item textarea {
  min-height: 80px;
  resize: vertical;
}

.color-picker-wrapper {
  display: flex;
  align-items: center;
  gap: var(--space-3);
}

.color-preview {
  width: 50px;
  height: 40px;
  border-radius: var(--border-radius-medium);
  border: 1px solid var(--color-border);
  cursor: pointer;
  transition: transform var(--transition-short);
}

.color-preview:hover {
  transform: scale(1.05);
}

.color-input {
  max-width: 150px !important;
}

.form-actions {
  margin-top: var(--space-6);
  padding-top: var(--space-5);
  border-top: 1px solid var(--color-border);
  display: flex;
  gap: var(--space-3);
}

.alert-success-settings {
  margin-bottom: var(--space-5);
  padding: var(--space-3) var(--space-4);
  background-color: var(--color-info-bg);
  border: 1px solid var(--color-info-border);
  border-radius: var(--border-radius-medium);
  color: var(--color-info-text);
}
</style>
{% endblock %}

{% block content %}
<div class="configuracoes-container">
  <h1>Configurações Globais</h1>
  
  <div class="settings-tabs">
    <button type="button" class="settings-tab active" data-tab="tema">Tema & Aparência</button>
    <button type="button" class="settings-tab" data-tab="clinica">Dados da Clínica</button>
    <button type="button" class="settings-tab" data-tab="preferencias">Preferências</button>
    <button type="button" class="settings-tab" data-tab="sistema">Sistema</button>
  </div>

  <form id="settings-form" hx-post="/admin/configuracoes/update" hx-swap="none">
    
    <!-- Seção: Tema & Aparência -->
    <div class="settings-section active" data-section="tema">
      <div class="settings-group">
        <h3>Personalização de Tema</h3>
        
        {% for setting in settings.get('tema', []) %}
          <div class="setting-item">
            <label for="setting-{{ setting.key }}">{{ setting.description or setting.key }}</label>
            
            {% if setting.key == 'THEME_PRIMARY_COLOR' %}
              <div class="color-picker-wrapper">
                <div class="color-preview" 
                     style="background-color: {{ setting.value or '#10b981' }};"
                     onclick="document.getElementById('setting-{{ setting.key }}').click()">
                </div>
                <input type="color" 
                       class="color-input" 
                       id="setting-{{ setting.key }}" 
                       name="{{ setting.key }}" 
                       value="{{ setting.value or '#10b981' }}"
                       onchange="document.querySelector('.color-preview').style.backgroundColor = this.value">
                <input type="text" 
                       class="form-control" 
                       value="{{ setting.value or '#10b981' }}" 
                       readonly
                       style="max-width: 150px;">
              </div>
            {% elif setting.key == 'THEME_MODE_DEFAULT' %}
              <select class="form-control" id="setting-{{ setting.key }}" name="{{ setting.key }}">
                <option value="light" {% if setting.value == 'light' %}selected{% endif %}>Claro</option>
                <option value="dark" {% if setting.value == 'dark' %}selected{% endif %}>Escuro</option>
              </select>
            {% else %}
              <input type="text" 
                     class="form-control" 
                     id="setting-{{ setting.key }}" 
                     name="{{ setting.key }}" 
                     value="{{ setting.value|e }}">
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Seção: Dados da Clínica -->
    <div class="settings-section" data-section="clinica">
      <div class="settings-group">
        <h3>Informações da Clínica</h3>
        
        {% for setting in settings.get('clinica', []) %}
          <div class="setting-item">
            <label for="setting-{{ setting.key }}">{{ setting.description or setting.key }}</label>
            <div class="setting-description">
              {% if setting.key == 'CLINIC_NAME' %}
                Nome completo da clínica ou consultório
              {% elif setting.key == 'CLINIC_PHONE' %}
                Telefone principal para contato
              {% elif setting.key == 'CLINIC_EMAIL' %}
                E-mail institucional da clínica
              {% elif setting.key == 'CLINIC_ADDRESS' %}
                Endereço completo da clínica
              {% elif setting.key == 'CLINIC_CNPJ' %}
                CNPJ da clínica (somente números)
              {% endif %}
            </div>
            {% if setting.key == 'CLINIC_ADDRESS' %}
              <textarea class="form-control" 
                        id="setting-{{ setting.key }}" 
                        name="{{ setting.key }}">{{ setting.value|e }}</textarea>
            {% else %}
              <input type="text" 
                     class="form-control" 
                     id="setting-{{ setting.key }}" 
                     name="{{ setting.key }}" 
                     value="{{ setting.value|e }}">
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Seção: Preferências -->
    <div class="settings-section" data-section="preferencias">
      <div class="settings-group">
        <h3>Preferências do Sistema</h3>
        
        {% for setting in settings.get('preferencias', []) %}
          <div class="setting-item">
            <label for="setting-{{ setting.key }}">{{ setting.description or setting.key }}</label>
            
            {% if setting.key == 'ENABLE_NOTIFICATIONS' %}
              <select class="form-control" id="setting-{{ setting.key }}" name="{{ setting.key }}">
                <option value="true" {% if setting.value == 'true' %}selected{% endif %}>Ativado</option>
                <option value="false" {% if setting.value == 'false' %}selected{% endif %}>Desativado</option>
              </select>
            {% elif setting.key == 'DEFAULT_APPOINTMENT_DURATION' %}
              <input type="number" 
                     class="form-control" 
                     id="setting-{{ setting.key }}" 
                     name="{{ setting.key }}" 
                     value="{{ setting.value|e }}"
                     min="10"
                     max="240"
                     step="5">
            {% else %}
              <input type="text" 
                     class="form-control" 
                     id="setting-{{ setting.key }}" 
                     name="{{ setting.key }}" 
                     value="{{ setting.value|e }}">
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Seção: Sistema -->
    <div class="settings-section" data-section="sistema">
      <div class="settings-group">
        <h3>Configurações de Sistema</h3>
        
        {% for setting in settings.get('sistema', []) %}
          <div class="setting-item">
            <label for="setting-{{ setting.key }}">{{ setting.description or setting.key }}</label>
            
            {% if setting.key == 'DEV_LOGS_ENABLED' %}
              <select class="form-control" id="setting-{{ setting.key }}" name="{{ setting.key }}">
                <option value="true" {% if setting.value == 'true' %}selected{% endif %}>Ativado</option>
                <option value="false" {% if setting.value == 'false' %}selected{% endif %}>Desativado</option>
              </select>
            {% else %}
              <input type="text" 
                     class="form-control" 
                     id="setting-{{ setting.key }}" 
                     name="{{ setting.key }}" 
                     value="{{ setting.value|e }}">
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Salvar Configurações</button>
      <button type="button" class="btn btn-secondary" onclick="window.location.reload()">Cancelar</button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tab switching
document.querySelectorAll('.settings-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    // Remove active from all tabs and sections
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
    
    // Add active to clicked tab and corresponding section
    this.classList.add('active');
    const sectionName = this.dataset.tab;
    document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
  });
});

// HTMX success handler
document.body.addEventListener('htmx:afterRequest', function(event) {
  if (event.detail.target.id === 'settings-form' && event.detail.successful) {
    // Show success message
    const alert = document.createElement('div');
    alert.className = 'alert-success-settings';
    alert.textContent = 'Configurações salvas com sucesso!';
    
    const container = document.querySelector('.configuracoes-container');
    container.insertBefore(alert, container.firstChild);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
      alert.remove();
    }, 3000);
    
    // Reload to apply theme changes
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  }
});
</script>
{% endblock %}
