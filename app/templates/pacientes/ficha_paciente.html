{% extends 'pacientes/paciente_layout.html' %}

{# Tela 1: Ficha + Anamnese #}
{# Conformidade: AGENTS.MD ¬ß2 (5 Telas), ¬ß8.2 (Sa√≠da Suja), ¬ß1 (BrasilAPI CEP) #}

{% set active_tab = 'ficha' %}

{% block title %}Ficha + Anamnese - {{ paciente.nome_completo }}{% endblock %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ficha_paciente.css') }}" />
{% endblock %}

{% block paciente_content %}
<div class="ficha-paciente-container">
  {# Alerta-√Çncora (Regra ¬ß7.4) #}
  {% if status.mostrar_alerta %}
  <div class="anamnese-alert" role="alert">
    <div class="alert-icon">‚ö†Ô∏è</div>
    <div class="alert-content">
      <strong>Anamnese {{ status.status }}</strong>
      {% if status.data_atualizacao %}
        <span class="alert-meta">Atualizada h√° {{ status.dias_desde_ultima_atualizacao }} dias</span>
      {% else %}
        <span class="alert-meta">Sem data registrada</span>
      {% endif %}
    </div>
    <a href="#anamnese-section" class="alert-action">Atualizar Agora</a>
  </div>
  {% endif %}

  {# Formul√°rio √önico - Regra ¬ß8.2 (Sa√≠da Suja) #}
  <form id="form-ficha-anamnese"
        method="POST"
        hx-post="{{ url_for('paciente_bp.atualizar_ficha', paciente_id=paciente.id) }}"
        hx-swap="none">

    {# Split Vertical Layout #}
    <div class="split-container">

      {# Painel Esquerdo: Ficha Cadastral #}
      <section class="split-left">
        <h3 class="panel-title">Ficha Cadastral</h3>

        <div class="form-group">
          <label for="nome_completo">Nome Completo <span class="required">*</span></label>
          <input type="text"
                 id="nome_completo"
                 name="nome_completo"
                 value="{{ paciente.nome_completo or '' }}"
                 required />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="data_nascimento">Data de Nascimento</label>
            <input type="date"
                   id="data_nascimento"
                   name="data_nascimento"
                   value="{{ paciente.data_nascimento or '' }}" />
          </div>
          <div class="form-group">
            <label for="sexo">Sexo</label>
            <select id="sexo" name="sexo">
              <option value="">-- Selecione --</option>
              {% if paciente.sexo and paciente.sexo.value == 'MASCULINO' %}
              <option value="MASCULINO" selected>Masculino</option>
              {% else %}
              <option value="MASCULINO">Masculino</option>
              {% endif %}
              {% if paciente.sexo and paciente.sexo.value == 'FEMININO' %}
              <option value="FEMININO" selected>Feminino</option>
              {% else %}
              <option value="FEMININO">Feminino</option>
              {% endif %}
              {% if paciente.sexo and paciente.sexo.value == 'OUTRO' %}
              <option value="OUTRO" selected>Outro</option>
              {% else %}
              <option value="OUTRO">Outro</option>
              {% endif %}
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="cpf">CPF</label>
            <input type="text"
                   id="cpf"
                   name="cpf"
                   value="{{ paciente.cpf or '' }}"
                   maxlength="14" />
          </div>
          <div class="form-group">
            <label for="telefone">Telefone</label>
            <input type="tel"
                   id="telefone"
                   name="telefone"
                   value="{{ paciente.telefone or '' }}" />
          </div>
        </div>

        <div class="form-group">
          <label for="email">E-mail</label>
          <input type="email"
                 id="email"
                 name="email"
                 value="{{ paciente.email or '' }}" />
        </div>

        {# Endere√ßo com CEP HTMX (Regra ¬ß1) #}
        <fieldset class="address-fieldset">
          <legend>Endere√ßo</legend>

          <div class="cep-lookup-group">
            <div class="form-group cep-input-wrapper">
              <label for="cep">CEP</label>
              <input type="text"
                     id="cep"
                     name="cep"
                     value="{{ paciente.cep or '' }}"
                     maxlength="9"
                     placeholder="00000-000" />
            </div>
            <button type="button"
                    class="btn btn-secondary btn-cep-search"
                    hx-post="{{ url_for('api_bp.buscar_cep') }}"
                    hx-include="[name='cep']"
                    hx-target="#endereco-fields"
                    hx-swap="innerHTML">
              Buscar CEP
            </button>
          </div>

          <div id="endereco-fields">
            {# Campos de endere√ßo - inicialmente populados ou vazios #}
            <div class="form-group">
              <label for="logradouro">Logradouro</label>
              <input type="text"
                     id="logradouro"
                     name="logradouro"
                     value="{{ paciente.logradouro or '' }}" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="numero">N√∫mero</label>
                <input type="text"
                       id="numero"
                       name="numero"
                       value="{{ paciente.numero or '' }}" />
              </div>
              <div class="form-group">
                <label for="complemento">Complemento</label>
                <input type="text"
                       id="complemento"
                       name="complemento"
                       value="{{ paciente.complemento or '' }}" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="bairro">Bairro</label>
                <input type="text"
                       id="bairro"
                       name="bairro"
                       value="{{ paciente.bairro or '' }}" />
              </div>
              <div class="form-group">
                <label for="cidade">Cidade</label>
                <input type="text"
                       id="cidade"
                       name="cidade"
                       value="{{ paciente.cidade or '' }}" />
              </div>
            </div>

            <div class="form-group">
              <label for="estado">Estado (UF)</label>
              <input type="text"
                     id="estado"
                     name="estado"
                     value="{{ paciente.estado or '' }}"
                     maxlength="2" />
            </div>
          </div>
        </fieldset>

      </section>

      {# Painel Direito: Anamnese #}
      <section class="split-right" id="anamnese-section">
        <h3 class="panel-title">Anamnese</h3>

        <div class="form-group">
          <label for="alergias">Alergias</label>
          <textarea id="alergias"
                    name="alergias"
                    rows="3"
                    placeholder="Descreva alergias conhecidas (medicamentos, alimentos, etc.)">{{ paciente.anamnese.alergias if paciente.anamnese else '' }}</textarea>
        </div>

        <div class="form-group">
          <label for="medicamentos_uso_continuo">Medicamentos de Uso Cont√≠nuo</label>
          <textarea id="medicamentos_uso_continuo"
                    name="medicamentos_uso_continuo"
                    rows="3"
                    placeholder="Liste medicamentos em uso regular">{{ paciente.anamnese.medicamentos_uso_continuo if paciente.anamnese else '' }}</textarea>
        </div>

        <div class="form-group">
          <label for="historico_doencas">Hist√≥rico de Doen√ßas</label>
          <textarea id="historico_doencas"
                    name="historico_doencas"
                    rows="4"
                    placeholder="Diabetes, hipertens√£o, cardiopatias, etc.">{{ paciente.anamnese.historico_doencas if paciente.anamnese else '' }}</textarea>
        </div>

        {# Red Flags Info (Read-Only) #}
        {% if paciente.anamnese and paciente.anamnese.has_red_flags %}
        <div class="info-banner red-flags-banner">
          <span class="info-icon">üö©</span>
          <span>Este paciente possui alertas cl√≠nicos registrados.</span>
        </div>
        {% endif %}

        {# Status da Anamnese (Read-Only Display) #}
        <div class="anamnese-meta">
          <div class="meta-item">
            <span class="meta-label">Status:</span>
            <span class="meta-value status-{{ status.status.lower() }}">{{ status.status }}</span>
          </div>
          {% if status.data_atualizacao %}
          <div class="meta-item">
            <span class="meta-label">√öltima Atualiza√ß√£o:</span>
            <span class="meta-value">{{ status.data_atualizacao.strftime('%d/%m/%Y') }}</span>
          </div>
          {% endif %}
        </div>

      </section>
    </div>

    {# A√ß√µes do Formul√°rio #}
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
      <a href="{{ url_for('paciente_bp.detalhe', paciente_id=paciente.id) }}" class="btn btn-secondary">Cancelar</a>
    </div>

  </form>

</div>
{% endblock %}
