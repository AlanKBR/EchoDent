<!-- Fragmento HTMX para Preview de Ajuste de Preços -->
{% if preview %}
<div class="preview-results">
    <div class="alert alert-warning mb-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4M12 17h.01"/>
        </svg>
        <div>
            <strong>{{ total_afetados }} tratamento(s) serão afetados</strong>
            {% if preview and (total_afetados != (preview|length)) %}
            <p class="mb-0">Exibindo os primeiros {{ preview|length }} resultados. Todos os {{ total_afetados }} tratamentos ativos serão ajustados.</p>
            {% endif %}
        </div>
    </div>

    <table class="table table-sm">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Categoria</th>
                <th class="text-end">Preço Atual</th>
                <th class="text-center">→</th>
                <th class="text-end">Preço Novo</th>
                <th class="text-end">Diferença</th>
            </tr>
        </thead>
        <tbody>
            {% for item in preview %}
            <tr>
                <td><strong>{{ item.nome }}</strong></td>
                <td><span class="badge badge-secondary badge-sm">{{ item.categoria }}</span></td>
                <td class="text-end">R$ {{ "%.2f"|format(item.preco_antigo) }}</td>
                <td class="text-center text-muted">→</td>
                <td class="text-end">
                    {% set diff_val = item.preco_novo - item.preco_antigo %}
                    {% set diff_str = "%.2f"|format(diff_val) %}
                    <strong class="{% if diff_str.startswith('-') %}text-danger{% else %}text-success{% endif %}">R$ {{ "%.2f"|format(item.preco_novo) }}</strong>
                </td>
                <td class="text-end">
                    {% set diff = diff_val %}
                    {% set dstr = diff_str %}
                    <span class="badge {% if dstr.startswith('-') %}badge-danger{% else %}badge-success{% endif %} badge-sm">
                        {% if dstr.startswith('-') %}-{% else %}+{% endif %}R$ {{ "%.2f"|format(diff|abs) }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="preview-summary">
        <div class="row text-center">
            <div class="col-md-4">
                <small class="text-muted d-block">Percentual Aplicado</small>
                {% set pabs = "%g"|format(percentual|abs) %}
                {% set pstr = "%g"|format(percentual) %}
                {% set plus = (pabs != '0' and not pstr.startswith('-')) %}
                <strong class="{% if plus %}text-success{% else %}text-danger{% endif %}">
                    {% if plus %}+{% endif %}{{ percentual }}%
                </strong>
            </div>
            <div class="col-md-4">
                <small class="text-muted d-block">Tratamentos Afetados</small>
                <strong class="text-primary">{{ total_afetados }}</strong>
            </div>
            <div class="col-md-4">
                <small class="text-muted d-block">Média de Ajuste</small>
                <strong>
                    {% set avg_diff = (preview|map(attribute='preco_novo')|sum - preview|map(attribute='preco_antigo')|sum) / preview|length %}
                    {% set avg_str = "%.2f"|format(avg_diff) %}
                    {% if avg_str.startswith('-') %}-{% else %}+{% endif %}R$ {{ "%.2f"|format(avg_diff|abs) }}
                </strong>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="text-center text-muted py-4">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/>
    </svg>
    <p class="mt-2">Nenhum tratamento ativo encontrado com os critérios selecionados.</p>
</div>
{% endif %}
