{% extends "base.html" %}
{% block title %}Logs de Auditoria{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}?v={{ asset_v }}" />
{% endblock %}

{% block content %}
<div class="settings-container">
  {% set active_tab = 'admin' %}
  {% include "settings/_tabs.html" %}

  <div class="settings-content">
    <div class="page-header">
      <div class="page-header-content">
        <h1 class="page-title">Logs de Auditoria</h1>
        <p class="page-subtitle">Rastreamento de mudan√ßas cr√≠ticas no sistema</p>
      </div>
    </div>

    {# Filtros #}
    <form method="GET" class="card mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <label for="user_id" class="form-label">Usu√°rio:</label>
            <select name="user_id" id="user_id" class="form-select">
              <option value="">Todos</option>
              {% for u in usuarios %}
              {% if request.args.get('user_id')|int == u.id %}
              <option value="{{ u.id }}" selected>{{ u.nome_completo or u.username }}</option>
              {% else %}
              <option value="{{ u.id }}">{{ u.nome_completo or u.username }}</option>
              {% endif %}
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3">
            <label for="model_name" class="form-label">Tabela:</label>
            <select name="model_name" id="model_name" class="form-select">
              <option value="">Todas</option>
              {% if request.args.get('model_name') == 'clinica_info' %}
              <option value="clinica_info" selected>Dados da Cl√≠nica</option>
              {% else %}
              <option value="clinica_info">Dados da Cl√≠nica</option>
              {% endif %}
              {% if request.args.get('model_name') == 'global_setting' %}
              <option value="global_setting" selected>Configura√ß√µes Globais</option>
              {% else %}
              <option value="global_setting">Configura√ß√µes Globais</option>
              {% endif %}
              {% if request.args.get('model_name') == 'usuarios' %}
              <option value="usuarios" selected>Usu√°rios</option>
              {% else %}
              <option value="usuarios">Usu√°rios</option>
              {% endif %}
              {% if request.args.get('model_name') == 'procedimento_mestre' %}
              <option value="procedimento_mestre" selected>Tratamentos</option>
              {% else %}
              <option value="procedimento_mestre">Tratamentos</option>
              {% endif %}
            </select>
          </div>

          <div class="col-md-2">
            <label for="action" class="form-label">A√ß√£o:</label>
            <select name="action" id="action" class="form-select">
              <option value="">Todas</option>
              {% if request.args.get('action') == 'create' %}
              <option value="create" selected>Cria√ß√£o</option>
              {% else %}
              <option value="create">Cria√ß√£o</option>
              {% endif %}
              {% if request.args.get('action') == 'update' %}
              <option value="update" selected>Atualiza√ß√£o</option>
              {% else %}
              <option value="update">Atualiza√ß√£o</option>
              {% endif %}
              {% if request.args.get('action') == 'delete' %}
              <option value="delete" selected>Exclus√£o</option>
              {% else %}
              <option value="delete">Exclus√£o</option>
              {% endif %}
            </select>
          </div>

          <div class="col-md-2">
            <label for="date_from" class="form-label">Data Inicial:</label>
            <input type="date" name="date_from" id="date_from" class="form-control" value="{{ request.args.get('date_from', '') }}">
          </div>

          <div class="col-md-2">
            <label for="date_to" class="form-label">Data Final:</label>
            <input type="date" name="date_to" id="date_to" class="form-control" value="{{ request.args.get('date_to', '') }}">
          </div>
        </div>

        <div class="mt-3">
          <button type="submit" class="btn btn-primary">
            <span class="btn-text">Filtrar</span>
            <span class="htmx-indicator">{% include 'utils/_spinner.html' %}</span>
          </button>
          <a href="{{ url_for('settings_bp.audit_logs') }}" class="btn btn-secondary">Limpar Filtros</a>
        </div>
      </div>
    </form>

    {# Tabela de Logs #}
    <div class="card">
      <div class="card-body p-0">
        {% if pagination and pagination.items %}
        <table class="table">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Usu√°rio</th>
              <th>A√ß√£o</th>
              <th>Tabela</th>
              <th>Registro ID</th>
              <th>Detalhes</th>
            </tr>
          </thead>
          <tbody>
            {% for log in pagination.items %}
            <tr>
              <td>
                <div>{{ log.timestamp.strftime('%d/%m/%Y') }}</div>
                <small class="text-muted">{{ log.timestamp.strftime('%H:%M:%S') }}</small>
              </td>
              <td>
                {% if log.user %}
                  {{ log.user.nome_completo or log.user.username }}
                  <small class="text-muted d-block">@{{ log.user.username }}</small>
                {% else %}
                  <span class="text-muted">Sistema</span>
                {% endif %}
              </td>
              <td>
                {% if log.action == 'create' %}
                  <span class="badge badge-success">{{ audit_service.format_action_name(log.action) }}</span>
                {% elif log.action == 'update' or log.action == 'UPDATE_MASSA' %}
                  <span class="badge badge-primary">{{ audit_service.format_action_name(log.action) }}</span>
                {% elif log.action == 'delete' %}
                  <span class="badge badge-danger">{{ audit_service.format_action_name(log.action) }}</span>
                {% else %}
                  <span class="badge badge-secondary">{{ audit_service.format_action_name(log.action) }}</span>
                {% endif %}
              </td>
              <td>{{ audit_service.format_model_name(log.model_name) }}</td>
              <td><code>#{{ log.model_id }}</code></td>
              <td>
                <button class="btn btn-sm btn-outline-secondary"
                        hx-get="{{ url_for('settings_bp.audit_log_detail', log_id=log.id) }}"
                        hx-target="#modal-container"
                        hx-swap="innerHTML">
                  Ver Detalhes
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

    {# Pagina√ß√£o #}
  {% if pagination and (pagination.has_next or pagination.has_prev) %}
        <nav aria-label="Pagina√ß√£o" class="p-3">
          <ul class="pagination justify-content-center mb-0">
            {% if pagination.has_prev %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('settings_bp.audit_logs', page=pagination.prev_num, **request.args) }}">Anterior</a>
            </li>
            {% endif %}

            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
              {% if page_num %}
                <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                  <a class="page-link" href="{{ url_for('settings_bp.audit_logs', page=page_num, **request.args) }}">{{ page_num }}</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
              {% endif %}
            {% endfor %}

            {% if pagination.has_next %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('settings_bp.audit_logs', page=pagination.next_num, **request.args) }}">Pr√≥ximo</a>
            </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}

        {% else %}
        <div class="empty-state">
          <div class="empty-state-icon">üìã</div>
          <h3 class="empty-state-title">Nenhum log encontrado</h3>
          <p class="empty-state-text">Ajuste os filtros para ver resultados.</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# Container para modal de detalhes #}
<div id="modal-container"></div>
{% endblock %}
